<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Profile">


    <select id="findByUserId" parameterType="long" resultType="com.spring.profile.dto.ProfileDTO">
        SELECT
        u.id AS userId,
        u.nickname,
        m.mbti,
        u.rating,
        u.point,
        DATE_FORMAT(u.createdAt, '%Y-%m-%d') AS joinedAt,
        u.fileId AS fileId            <!-- ✅ 프로필 이미지용 -->
        FROM user u
        LEFT JOIN mbti m ON u.mbtiId = m.id
        WHERE u.id = #{userId}
    </select>

    <select id="findFriendsByUserId" parameterType="long" resultMap="FriendMap">
        SELECT
        u.id AS userId,
        u.nickname,
        m.mbti,
        u.fileId AS fileId            <!-- ✅ 썸네일 -->
        FROM friends f
        JOIN user u ON f.responseUserId = u.id
        LEFT JOIN mbti m ON u.mbtiId = m.id
        WHERE f.requestUserId = #{userId}
        AND f.status = 1
        ORDER BY f.requestedAt DESC       <!-- ✅ f.id 없는 경우 대비 -->
    </select>

    <resultMap id="FriendMap" type="com.spring.profile.dto.ProfileDTO">
        <result property="userId"  column="userId"/>
        <result property="nickname" column="nickname"/>
        <result property="mbti"    column="mbti"/>
        <result property="fileId"  column="fileId"/>  <!-- ✅ -->
    </resultMap>

    <select id="findById" parameterType="long" resultType="com.spring.mbti.dto.MbtiBoardDTO">
        SELECT * FROM mbtiboard WHERE id = #{id}
    </select>

    <update id="updateFileId" parameterType="map">
        UPDATE user
        SET fileId = #{fileId,jdbcType=INTEGER}
        WHERE id = #{userId,jdbcType=BIGINT}
    </update>


</mapper>
